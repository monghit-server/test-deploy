name: Deploy

on:
  push:
    branches:
      - main

jobs:
  # Crear tag de version
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create tag if not exists
        run: |
          if ! git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git tag -a "v${{ steps.version.outputs.version }}" -m "Version ${{ steps.version.outputs.version }}"
            git push origin "v${{ steps.version.outputs.version }}"
          fi

      - name: Notify on failure
        if: failure()
        uses: monghit-server/.github/actions/notify-telegram@main
        with:
          webhook_url: ${{ secrets.N8N_WEBHOOK_TO_TELEGRAM_URL }}
          event: create_tag_failed
          repository: ${{ github.repository }}
          actor: ${{ github.actor }}
          run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          version: ${{ steps.version.outputs.version }}

  # Build usando workflow centralizado
  build:
    needs: create-tag
    uses: monghit-server/.github/.github/workflows/docker-build.yml@main
    with:
      image_name: ${{ github.repository }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Deploy usando workflow centralizado
  deploy:
    needs: [create-tag, build]
    uses: monghit-server/.github/.github/workflows/deploy.yml@main
    with:
      app_name: test-deploy
      app_path: /opt/apps/test-deploy
      health_url: https://test.monghit.com/health
      version: ${{ needs.create-tag.outputs.version }}
    secrets:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      N8N_WEBHOOK_TO_TELEGRAM_URL: ${{ secrets.N8N_WEBHOOK_TO_TELEGRAM_URL }}
